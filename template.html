<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>
		
	</title>
	<script src="./libraries/babel.min.js"></script>
	<script src="./libraries/react.development.js"></script>
	<script src="./libraries/react-dom.development.js"></script>
	
	<!-- redux https://unpkg.com/redux@4.2.0/dist/redux.js -->
	<script src="./libraries/redux.js"></script>
	
	<!-- react-redux https://cdnjs.cloudflare.com/ajax/libs/react-redux/8.0.5/react-redux.js -->
	<script src="./libraries/react-redux.js"></script>
	
	<!-- font awesome icons -->
	<link href='./libraries/css/all.css' rel='stylesheet'>

	
	
	
	<style>
		body{
			margin: 0;
		}
		*{
			outline:2px solid black;
			font-family: 'Lucida Consolas', monospace, 'Tahoma', sans-serif;
			color: black
		}
		button{
			cursor:pointer;
		}
		button:hover{
			
			filter: brightness(1.5);
		}
		/*hover effect on icons too*/
		i:hover{
			
			filter: brightness(1.5);
		}

	</style>
</head>
  
<body>
	<main>
		<div id="react-container-1" class="react-container">
		
		<div>
	</main>
	
	<script type="text/babel">
		const evalExp=(value0,returnSteps=false)=>{
			const steps=[];
			steps.push(`original,		${value0}`);
			
			/*0. sanitize input; removing everything that is not part of a math expression*/
			let newValue0= value0.replace(/[^+\-x*/\.\d]/g,'');
			steps.push(`--- step 0,		${newValue0}`);
			
			/*00. remove 'consecutive' .
			
			e.g.
			511.5.5.5.5		=>		511.5555
			*/
			newValue0=newValue0.replace(/(\d+\.)+\d+/g,s=>{
				//get 511.
				const s1=s.match(/\d+\./);
				
				//get .5.5.5.5
				const s2=s.match(/(\.\d+)+/g)[0];
				
				//remove . from .5.5.5.5
				const s22=s2.replace(/\./g,'');
				
				return `${s1}${s22}`;
			})
			
			steps.push(`--- step 00,		${newValue0}`);
			//console.log('--- new value 0',newValue0);
			
			/*1. replace 'x' with '*'*/
			newValue0=newValue0.replace(/x/g,'*');
			steps.push(`--- step 1,		${newValue0}`);
			//console.log('--- new value 1',newValue0);
			
			/*2. ony put parenthesis around negative terms;
				a.	there is atleast 1 operator before -
			of syntax -iiiii as (-iiiii) 
			
			e.g.
			5*-5	=>		5*(-5)
			*/
			newValue0=newValue0.replace(/([+\-*/]+)(-\d+(.\d+)?)/g,'$1($2)');
			//newValue0= newValue0.replace(/-\d+(.\d+)?/g,s=>`+(${s})`);
			steps.push(`--- step 2,		${newValue0}`);
			//console.log('--- new value 2',newValue0);
			
			/*3. for every >=2 cosecutive operators, only keep last operator*/
			
			newValue0= newValue0.replace(/[+\-*/]{2,}/g,s=>s.at(-1));
			//console.log('--- new value 3',newValue0);
			steps.push(`--- step 3,		${newValue0}`);
			
			/*4. eval uate math expression*/
			try{
				newValue0=eval(newValue0);
				//console.log('--- new value 4',newValue0);
			}
			catch(e){
				newValue0='ERROR';
			}
			steps.push(`--- step 4,		${newValue0}`);
			
			return returnSteps===true ? [newValue0,steps] : newValue0;
		}
		//------------------------------- actions -------------------------------//

		//------------------------------- new state -------------------------------//
		const operators= ['+', '-', '*', '/'];
		const errors={
			'div-by-zero': 'Invalid operation, division by zero',
			'leading-zeros':'Invalid input, leading zero values',
			'exp':'Invalid expression'
		};
		const state0={
			'value':0,
			'display-1':'0',
			'prev-decimal-point':false,
			'error':false,
			'display-1-initial':true,
			'display-2':'',/*user input*/
			'num-button-border-top':'0.1rem solid black',
			'num-button-border-left':'0.1rem solid black',
			/*clear button*/
			'clear-button-border':'0.1rem solid black',

			'clear-button-border-bottom-style':'solid',
			'clear-button-border-right-style':'solid',
			'clear-button-border-bottom-color':'black',
			'clear-button-border-right-color':'black',

		}
		
		//state & return new state
		const reducer=(state={...state0}, action)=>{
	
			

			switch(action.type){
				case 'num-button-click':
					let {info:value}= action;
					
					//ignore consecutive decimal points
					if(value==='.'){
						if(state['prev-decimal-point']===true){
							value='';
						}
						state['prev-decimal-point']=true;
					}
					else{
						state['prev-decimal-point']=false;
					}
					
					const wasInitial= state['display-1-initial']===true;
					const isZero= value==='0';
					
					const isDecimalPoint= value==='.';
					const newValue= (wasInitial===false || isDecimalPoint===true || operators.includes(value)) ? state['display-1']+value : value;
					
					/*does number have leading zero vaules*/
					const isLeadingZeros=/0\d+/.test(newValue)
					
					const error= isLeadingZeros===true;
					return {
						...state,
						'error': error,
						'display-1-initial': error===false ? false : true,
						'display-1': error? (isLeadingZeros? errors['leading-zeros'] : errors['exp'] ) : newValue
					};

				case 'clear-click':
					return {
						...state,
						'display-1-initial': true,
						'display-1':state0['display-1'],
						'display-2':state0['display-2'],
						'value':state0['value']
					};
				
				case 'equals-click':
					const value0=state['display-1'];
					console.log('old value',value0);
					
					const newValue0=evalExp(value0);
					
					return {
						...state,
						'display-1-initial': true,
						'display-1':newValue0,
						'display-2':state0['display-2'],
						'value':state0['value']
					};
				case 'clear-up':
					console.log('==',state['display-1']);
					return {
						...state,
						'clear-button-border-bottom-color':state0['clear-button-border-bottom-color'],
						'clear-button-border-right-color':state0['clear-button-border-right-color'],
						'clear-button-border-bottom-style':state0['clear-button-border-bottom-style'],
						'clear-button-border-right-style':state0['clear-button-border-right-style']
					};
				
				case 'clear-down':
					console.log('==',state['display-1']);
					return {
						...state,
						'clear-button-border-bottom-color':'gray',
						'clear-button-border-right-color':'gray',
						'clear-button-border-bottom-style':'inset',
						'clear-button-border-right-style':'inset'
					};
					
				
				case 'num-button-down':
					action.target.style['border-bottom']= '0.1rem inset gray';
					action.target.style['border-right']= '0.1rem inset gray';
					return state;

				case 'num-button-up':
					action.target.style['border-bottom']= state0['num-button-border-top'];
					action.target.style['border-right']= state0['num-button-border-left'];
					return state;

				default:
					return state;
				}

		}
		//--------------------------- map state to props ---------------------------//
		//which parts of state to access
		const mapStateToProps= state=>(state);
		//--------------------------- map state to props ---------------------------//
		//
		const mapDispatchToProps= dispatchFunction=>({
			'do-num-button-click': (event,text)=>dispatchFunction({type:'num-button-click', info:text}),
			'do-clear-click': (event)=>dispatchFunction({type:'clear-click'}),
			'do-equals-click': (event)=>dispatchFunction({type:'equals-click'}),
			'do-button-hover': event=>dispatchFunction({type:'button-hover',target:event.target}),
			'do-button-leave': event=>dispatchFunction({type:'button-mouse-leave',target:event.target}),
			'do-num-button-down': event=>dispatchFunction({type:'num-button-down',target:event.target}),
			'do-num-button-up': event=>dispatchFunction({type:'num-button-up',target:event.target}),
			'do-clear-down': event=>dispatchFunction({type:'clear-down'}),
			'do-clear-up': event=>dispatchFunction({type:'clear-up'})

		});
		//react component Provider
		const Provider = ReactRedux.Provider;
		//connect function
		const connect= ReactRedux.connect;
		//store i.e. STATE object
		const store= Redux.createStore(reducer);
		//--------------------------- Button ---------------------------//
		const Button= props=> {
			const {text,all,id,onClick}=props;

			const style={
				padding:'.5rem 1rem',
				'background-color':'teal',
				'font-size': '2rem',
				'border':'0.1rem solid black',
				/*simulate button push effect*/
				'border-top':all['num-button-border-top'],
				'border-left':all['num-button-border-left'],
				...props.style,
			};
			const onClickDefault = e=>all['do-num-button-click'](e,text);
			return <button id={id} style={style} onClick={onClick===undefined ? onClickDefault : onClick}
			onMouseDown={all['do-num-button-down']} onMouseUp={all['do-num-button-up']}
			>
				{text}
			</button>;
		};
		//--------------------------- Display ---------------------------//
		const Display= props=> {
			const {all}=props;
			const {'display-1':text1,'display-2':text2}=all;
			
			const style={
				'display':'grid',
				'grid-template-columns':'3fr auto',
				'grid-template-rows':'repeat(2,auto)',
				'align-self':'stretch',
				'justify-self':'stretch',
				'font-size': '1rem',
				'gap': '1rem',
				...props.style,
			};
			
			//result display
			const display1Style={
				'grid-column':'1/3',
				'text-align':'right',
				'font-size': '4rem'
			};
			
			const clearStyle={
				'grid-column':'2/3',
				'grid-row':'2/3',
				'cursor':'pointer',
				color:'teal',
				'font-size': '2rem',
				border:all['clear-button-border'],
				'border-right-style': all['clear-button-border-right-style'],
				'border-right-color': all['clear-button-border-right-color'],
				'border-bottom-style': all['clear-button-border-bottom-style'],
				'border-bottom-color': all['clear-button-border-bottom-color']
			};
			
			//user input display
			const display2Style={
				'grid-column':'1/2',
				'grid-row':'2/3',
				'text-align':'right',
				'font-size': '2rem',
				'overflow-x':'auto'
			};
			

			return <div style={style}>
				<div id='display' style={display1Style}>{text1}</div>
				<div id='display2' style={display2Style}>{text2}</div>
				<i id='clear' style={clearStyle} className="fa-solid fa-delete-left" onClick={all['do-clear-click']} onMouseUp={all['do-clear-up']} onMouseDown={all['do-clear-down']}></i>
			</div>;
		};
		//--------------------------- Keys ---------------------------//
		const Keys=props=>{
			const {all}=props;

			const style={
				/*width:'50%',*/
				display:'grid',
				'grid-template-columns':'repeat(4,minmax(0,1fr))',
				'background-color':'green',
				...props.style
			};
			
			const operationsStyle={
				'margin':'0.5rem 0'
			};
			
			const keys='1/one 2/two 3/three 4/four 5/five 6/six 7/seven 8/eight 9/nine 0/zero ./decimal';
			
			const array=keys.split(' ').map(s0=>{
				const [s,id]=s0.split('/');
				return <Button text={s} id={id} all={all}/>;
			});

			return (<div style={style}>
				<Button style={operationsStyle} id="add" text={'+'} all={all}/>
				<Button style={operationsStyle} id="subtract" text={'-'} all={all}/>
				<Button style={operationsStyle} id="multiply" text={'x'} all={all}/>
				<Button style={operationsStyle} id="divide" text={'/'} all={all}/>
				
				{array}
				
				<Button text={'='} id="equals" all={all} style={{'background-color':'tomato'}}
				onClick={all['do-equals-click']}
				/>
			
			</div>);

		};
		//--------------------------- Calc ---------------------------//
		const Calc= props=> {
			const {text,all}=props;
			

			const style={
				'display':'grid',
				'justify-items':'stretch',
				/*'background-color': 'red',*/
				...props.style
			};
			const buttonStyle={
				'padding': '2em'
			};


			return (
			<div style={style}>
				
				<Display text={text} all={all}/>
				<Keys style={{'justify-self':'center'}} all={all}/>

			</div>);
		};

		//--------------------------- App ---------------------------//
		//component App WITHOUT LOCAL STATE
		class App extends React.Component{
			constructor(props){
				super(props);
			
			}
			componentDidMount(){
				const display2= document.querySelector('#display2');
				display2.style.width= `${display2.clientWidth}`;
				console.log(display2,display2.clientWidth,display2.style.width);
				/**/
				let array=[
					[' 5 . 5 . 5 '				,'5.55'		],
					['0/2'						,'0'		],
					[' 5 x 1 + 5 + 92 '			,'102'		],
					[' 3 + 5 x 6 - 2 / 4 '		,'32.5'		],
					[' 5 - 9 + 5 '				,'1'		],
					[' 10.5 - 5.5 '				,'5'		],
					[' 5 x 5.5 '				,'27.5'		],
					[' 10.5 + 5.5 '				,'16'		],
					[' 10 / 2.5 '				,'4'		],
					[' 5 x - 5 '				,'-25'		],
					[' 5 x - + 5 '				,'10'		],
					[' 5 + + 5 '				,'10'		],
					[' 5 - 2 '					,'3'		],
					[' 3 / 2 '					,'1.5'		],
					[' 5 + 5 '					,'10'		],
					[' 10 + 3 '					,'13'		],
					[' 2 / 7 '					,'0.2857142857142857'			]
				];
				array=array.map(sub=>{
					const [e,v1]=sub;
					const [v2,steps]=evalExp(e,true);
					return sub.concat(v1==v2 ? v2 : [`expected ${v1}`,`got     ${v2}`,'steps:'].concat(steps).join('\n'));
				});
				console.table(array);
			}
			render(){
				const headerFooterStyle={
					'text-align':'center',
					'font-weight':'bold'
				};
				const style= {
					'display':'grid',
					'grid-template-rows': '0.5fr 1fr 0.5fr',
					/**/
					'align-items':'center',
					'justify-items':'center',
					/**/
					'background-color': 'wheat',
					'height': '100vh',
					
				};
				const all={
					...this.props
				};
				
				//calculator
				const calcStyle={
				};
				return (
				<div style={style}>
					<h1 style={headerFooterStyle}>React Redux JS Calculator</h1>
					
					<Calc style={calcStyle} text={this.props['display']} 
					all={all}/>
					
					<footer style={headerFooterStyle}><p>by Abdullah Fatota</p></footer>
				</div>);
			}
		}
		//--------------------------- App2 ---------------------------//
		const App2= connect(mapStateToProps, mapDispatchToProps)(App);
		
		//--------------------------- AppWrapper ---------------------------//
		//react componentAppWrapper
		class AppWrapper extends React.Component{
			constructor(props){
				super(props);		
			}
			render(){
				//store prop IS REQUIRED.
				return (<Provider store={store}>
					<App2/>
				</Provider>);
			}
		}
	
		//--------------------------- attach AppWrapper to document ---------------------------//
		const container=document.querySelector('#react-container-1');
		ReactDOM.render(<AppWrapper/>,container);

	</script>
	
	<!-- free code camp test suite -->
	<script src="./libraries/test bundle.js"></script>

	
</body>

</html>